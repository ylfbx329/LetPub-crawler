{% extends 'base.html' %}

{% block title %}期刊国家分布{% endblock %}

{% block content %}
    <div class="container mt-4">
        <div id="country-chart" style="width: 100%; height: 600px;"></div>

        <div id="countryMap" style="height: 600px;"></div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        const countryData = {{ chart_data | safe }};

        const chartDom = document.getElementById('country-chart');
        const myChart = echarts.init(chartDom);
        const option = {
            title: {
                text: '期刊国家分布',
                left: 'center'
            },
            tooltip: {
                trigger: 'item'
            },
            toolbox: {
                show: true,
                feature: {
                    saveAsImage: {},       // 保存为图片
                    restore: {},           // 还原
                    dataView: {},           // 数据视图，可编辑
                    dataZoom: {},         // 区域缩放（仅在 xAxis 为类目轴时生效）
                    magicType: {type: ['line', 'bar', 'stack']}, // 切换为折线图/柱状图
                }
            },
            legend: {
                type: 'scroll',
                orient: 'vertical',
                right: 10,
                top: 50,
                bottom: 50
            },
            series: [
                {
                    name: '国家',
                    type: 'pie',
                    radius: '60%',
                    center: ['40%', '50%'],  // 左移饼图中心
                    data: countryData,
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    }
                }
            ]
        };

        myChart.setOption(option);
    </script>
    <script>
        // 如果你用 fetch 加载了 world.json，则需要：
        fetch('/static/echarts/map/js/world.js')
            .then(res => res.json())
            .then(geoJson => {
                echarts.registerMap('world', geoJson);
                myChart.setOption(option);  // 在地图注册后再 setOption
            });

        const maxCount = {{ max_count }};

        const mapChart = echarts.init(document.getElementById('countryMap'));
        const mapoption = {
            title: {
                text: '各国期刊数量分布',
                left: 'center'
            },
            tooltip: {
                trigger: 'item',
                formatter: '{b}<br/>期刊数量: {c}'
            },
            visualMap: {
                min: 0,
                max: maxCount,
                text: ['多', '少'],
                realtime: true,
                calculable: true,
                left: 'left',
                bottom: '5%'
            },
            series: [{
                name: '期刊数量',
                type: 'map',
                map: 'world',
                roam: true,
                emphasis: {
                    label: {show: true}
                },
                data: countryData
            }]
        };
        mapChart.setOption(mapoption);
    </script>
{% endblock %}
